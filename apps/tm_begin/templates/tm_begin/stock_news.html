{# templates/common/for_tm_begin/stock_news.html #}
{% extends 'common/base.html' %}
{% load static %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/stock_news.css' %}">
{% endblock %}

{% block content %}
<div class="stock_news news-page">
  <h2>ğŸ“° {{ headline|default:"ìµœì‹  ë‰´ìŠ¤" }}</h2>
  <p class="inv-sub" id="news-meta"></p>

  <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
  <div id="loading-spinner" class="loading-spinner-overlay">
    <div class="spinner"></div>
  </div>

  <!-- ë‰´ìŠ¤ ì½˜í…ì¸ ê°€ ë™ì ìœ¼ë¡œ ì±„ì›Œì§ˆ ì»¨í…Œì´ë„ˆ -->
  <div id="news-content"></div>

  <!-- í˜ì´ì§€ë„¤ì´ì…˜ ì»¨í…Œì´ë„ˆ -->
  <nav id="pagination-container" class="inv-pagination" aria-label="ë‰´ìŠ¤ í˜ì´ì§€"></nav>

  {# (ì„ íƒ) ìœ„ì ¯ ëª¨ë“œ: ì¿¼ë¦¬ìŠ¤íŠ¸ë§ ?widget=1 ì´ë©´ iframe í‘œì‹œ #}
  {% if widget_embed_url %}
    <div class="mt-4">
      <iframe src="{{ widget_embed_url }}" width="100%" height="600" frameborder="0" loading="lazy"></iframe>
    </div>
  {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const newsContent = document.getElementById("news-content");
  const newsMeta = document.getElementById("news-meta");
  const paginationContainer = document.getElementById("pagination-container");
  const loadingSpinner = document.getElementById("loading-spinner");

  // í˜„ì¬ URLì—ì„œ í˜ì´ì§€ ë²ˆí˜¸ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
  const urlParams = new URLSearchParams(window.location.search);
  let currentPage = parseInt(urlParams.get('page')) || 1;

  // ë‰´ìŠ¤ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
  function fetchAndRenderNews(page) {
    loadingSpinner.style.display = 'flex'; // ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ

    fetch(`{% url 'tm_begin:stock_news_json' %}?page=${page}`)
      .then(response => response.json())
      .then(data => {
        // ê¸°ì¡´ ì½˜í…ì¸  ì´ˆê¸°í™”
        newsContent.innerHTML = '';
        newsMeta.innerHTML = '';
        paginationContainer.innerHTML = '';

        // ë©”íƒ€ ì •ë³´ ì—…ë°ì´íŠ¸
        if (data.updated_at) {
          newsMeta.textContent = `ì—…ë°ì´íŠ¸: ${data.updated_at} (ì´ í˜ì´ì§€ ${data.count}ê±´ / ì´ ${data.total}ê±´)`;
        }

        // íˆì–´ë¡œ ì•„ì´í…œ ë Œë”ë§
        if (data.hero_item) {
          newsContent.innerHTML += renderHeroItem(data.hero_item);
        }

        // ê·¸ë¦¬ë“œ ì•„ì´í…œ ë Œë”ë§
        const gridContainer = document.createElement('div');
        gridContainer.className = 'inv-row';
        data.grid_items.forEach(item => {
          gridContainer.innerHTML += renderGridItem(item);
        });
        newsContent.appendChild(gridContainer);

        // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
        renderPagination(data);

        loadingSpinner.style.display = 'none'; // ë¡œë”© ìŠ¤í”¼ë„ˆ ìˆ¨ê¹€
      })
      .catch(error => {
        console.error('Error fetching news:', error);
        newsContent.innerHTML = '<p>ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
        loadingSpinner.style.display = 'none'; // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ìŠ¤í”¼ë„ˆ ìˆ¨ê¹€
      });
  }

  // íˆì–´ë¡œ ì•„ì´í…œ HTML ìƒì„±
  function renderHeroItem(item) {
    const image = item.img ? `<img src="${item.img}" alt="${item.title}">` : '<div class="no-image"><span>ğŸ“ˆ</span></div>';
    const summary = item.summary ? `<p class="inv-desc inv-line-5">${item.summary}</p>` : '';
    return `
      <article class="inv-hero">
        <div class="inv-hero-img">
          <a href="${item.link}" target="_blank" rel="noopener">
            ${image}
          </a>
        </div>
        <div class="inv-hero-content">
          <a href="${item.link}" target="_blank" rel="noopener" class="inv-title-lg">
            ${item.title}
          </a>
          ${summary}
          <div class="inv-meta">
            <time>${item.published}</time>
            <span>${item.source}</span>
          </div>
        </div>
      </article>
    `;
  }

  // ê·¸ë¦¬ë“œ ì•„ì´í…œ HTML ìƒì„±
  function renderGridItem(item) {
    const image = item.img ? `<img src="${item.img}" alt="${item.title}">` : '<div class="no-image-small"><span>ğŸ“°</span></div>';
    const summary = item.summary ? `<p class="inv-desc inv-line-3">${item.summary}</p>` : '';
    return `
      <article class="inv-card">
        <a href="${item.link}" target="_blank" rel="noopener" class="inv-thumb">
          ${image}
        </a>
        <a href="${item.link}" target="_blank" rel="noopener" class="inv-title inv-line-2">
          ${item.title}
        </a>
        ${summary}
        <div class="inv-meta">
          <time>${item.published}</time>
          <span>${item.source}</span>
        </div>
      </article>
    `;
  }

  // í˜ì´ì§€ë„¤ì´ì…˜ HTML ìƒì„±
  function renderPagination(data) {
    if (data.total_pages > 1) {
      let paginationHTML = '';
      // ì²« í˜ì´ì§€, ì´ì „ í˜ì´ì§€
      paginationHTML += `<a class="inv-page ${!data.has_prev ? 'disabled' : ''}" href="?page=1" data-page="1">Â«</a>`;
      paginationHTML += `<a class="inv-page ${!data.has_prev ? 'disabled' : ''}" href="?page=${data.prev_page}" data-page="${data.prev_page}">â€¹</a>`;

      // í˜ì´ì§€ ë²ˆí˜¸
      data.page_numbers.forEach(n => {
        if (n === data.page) {
          paginationHTML += `<span class="inv-page active">${n}</span>`;
        } else {
          paginationHTML += `<a class="inv-page" href="?page=${n}" data-page="${n}">${n}</a>`;
        }
      });

      // ë‹¤ìŒ í˜ì´ì§€, ë§ˆì§€ë§‰ í˜ì´ì§€
      paginationHTML += `<a class="inv-page ${!data.has_next ? 'disabled' : ''}" href="?page=${data.next_page}" data-page="${data.next_page}">â€º</a>`;
      paginationHTML += `<a class="inv-page ${!data.has_next ? 'disabled' : ''}" href="?page=${data.total_pages}" data-page="${data.total_pages}">Â»</a>`;

      paginationContainer.innerHTML = paginationHTML;
    }
  }

  // í˜ì´ì§€ë„¤ì´ì…˜ ë§í¬ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
  paginationContainer.addEventListener('click', function(e) {
    if (e.target.tagName === 'A' && e.target.dataset.page) {
      e.preventDefault(); // ê¸°ë³¸ ë§í¬ ë™ì‘ ë°©ì§€
      const page = parseInt(e.target.dataset.page);
      if (page !== currentPage) {
        currentPage = page;
        // URLì˜ page ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì—…ë°ì´íŠ¸
        window.history.pushState({path:`?page=${page}`},'',`?page=${page}`);
        fetchAndRenderNews(page);
      }
    }
  });

  // ì´ˆê¸° ë¡œë“œ
  fetchAndRenderNews(currentPage);
});
</script>
{% endblock %}
