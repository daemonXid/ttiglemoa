{% extends 'common/base.html' %}
{% load static %}

{% block title %}포트폴리오 | Ttiglemoa{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">포트폴리오</h2>
  <div class="btn-group">
    <a class="btn btn-sm btn-outline-primary" href="{% url 'tm_assets:create_deposit' %}">예적금 추가</a>
    <a class="btn btn-sm btn-outline-success" href="{% url 'tm_assets:create_stock' %}">주식 추가</a>
    <a class="btn btn-sm btn-outline-secondary" href="{% url 'tm_assets:create_bond' %}">채권 추가</a>
    <a class="btn btn-sm btn-outline-dark" href="{% url 'tm_assets:refresh_prices' %}">가격 새로고침</a>
  </div>
  
</div>

<div class="row g-3 mb-4">
  <div class="col-12 col-lg-6">
    <div class="card">
      <div class="card-header">자산 합계</div>
      <div class="card-body">
        <ul class="list-group">
          <li class="list-group-item d-flex justify-content-between">
            <span>예금/적금</span>
            <strong>{{ class_totals.CASH|floatformat:2 }}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>주식</span>
            <strong>{{ class_totals.STOCK|floatformat:2 }}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>채권</span>
            <strong>{{ class_totals.BOND|floatformat:2 }}</strong>
          </li>
        </ul>
        <small class="text-muted d-block mt-2">통화가 다르면 합계가 왜곡될 수 있습니다.</small>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-6">
    <div class="card">
      <div class="card-header">통화별 합계</div>
      <div class="card-body">
        {% if totals_by_currency %}
          <ul class="list-group">
            {% for currency, total in totals_by_currency.items %}
              <li class="list-group-item d-flex justify-content-between">
                <span>{{ currency }}</span>
                <strong>{{ total|floatformat:2 }}</strong>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted mb-0">등록된 자산이 없습니다.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="row g-3">
  <div class="col-12 col-lg-6">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>예적금</span>
        <a class="btn btn-sm btn-primary" href="{% url 'tm_assets:create_deposit' %}">추가</a>
      </div>
      <div class="card-body">
        {% if deposits %}
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>은행</th>
                  <th>상품</th>
                  <th>원금</th>
                  <th>연이율(%)</th>
                  <th>평가액</th>
                  <th>통화</th>
                  <th>동작</th>
                </tr>
              </thead>
              <tbody>
                {% for d in deposits %}
                  <tr>
                    <td>{{ d.bank_name }}</td>
                    <td>{{ d.product_name }} ({{ d.get_product_type_display }})</td>
                    <td>{{ d.principal_amount|floatformat:2 }}</td>
                    <td>{{ d.annual_rate|floatformat:2 }}</td>
                    <td>{{ d.estimated_value|floatformat:2 }}</td>
                    <td>{{ d.currency }}</td>
                    <td>
                      <a class="btn btn-sm btn-outline-primary" href="{% url 'tm_assets:edit_deposit' d.pk %}">수정</a>
                      <form method="post" action="{% url 'tm_assets:delete_deposit' d.pk %}" class="d-inline">
                        {% csrf_token %}
                        <button class="btn btn-sm btn-outline-danger" type="submit" onclick="return confirm('삭제하시겠습니까?');">삭제</button>
                      </form>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted mb-0">등록된 예적금이 없습니다.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-6">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>주식</span>
        <a class="btn btn-sm btn-success" href="{% url 'tm_assets:create_stock' %}">추가</a>
      </div>
      <div class="card-body">
        {% if stocks %}
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>시장</th>
                  <th>티커</th>
                  <th>수량</th>
                  <th>평단가</th>
                  <th>현재가</th>
                  <th>평가액</th>
                  <th>통화</th>
                  <th>동작</th>
                </tr>
              </thead>
              <tbody>
                {% for s in stocks %}
                  <tr>
                    <td>{{ s.get_market_display }}</td>
                    <td>{{ s.ticker }}</td>
                    <td>{{ s.quantity|floatformat:2 }}</td>
                    <td>{{ s.average_price|floatformat:2 }}</td>
                    <td>
                      {% if s.current_price is not None %}
                        {{ s.current_price|floatformat:2 }}
                      {% else %}
                        -
                      {% endif %}
                    </td>
                    <td>
                      <span{% if s.valuation_class %} class="{{ s.valuation_class }}"{% endif %}>
                        {{ s.estimated_total|floatformat:2 }}
                      </span>
                    </td>
                    <td>{{ s.currency }}</td>
                    <td>
                      <a class="btn btn-sm btn-outline-primary" href="{% url 'tm_assets:edit_stock' s.pk %}">수정</a>
                      <form method="post" action="{% url 'tm_assets:delete_stock' s.pk %}" class="d-inline">
                        {% csrf_token %}
                        <button class="btn btn-sm btn-outline-danger" type="submit" onclick="return confirm('삭제하시겠습니까?');">삭제</button>
                      </form>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted mb-0">등록된 주식이 없습니다.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>채권</span>
        <a class="btn btn-sm btn-secondary" href="{% url 'tm_assets:create_bond' %}">추가</a>
      </div>
      <div class="card-body">
        {% if bonds %}
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>명칭</th>
                  <th>발행사</th>
                  <th>액면총액</th>
                  <th>매수가(%)</th>
                  <th>현재가(%)</th>
                  <th>만기</th>
                  <th>평가액</th>
                  <th>통화</th>
                  <th>동작</th>
                </tr>
              </thead>
              <tbody>
                {% for b in bonds %}
                  <tr>
                    <td>{{ b.name }}</td>
                    <td>{{ b.issuer|default:"-" }}</td>
                    <td>{{ b.face_amount|floatformat:2 }}</td>
                    <td>{{ b.purchase_price_pct|floatformat:2 }}</td>
                    <td>
                      {% if b.current_price_pct is not None %}
                        {{ b.current_price_pct|floatformat:2 }}
                      {% else %}
                        -
                      {% endif %}
                    </td>
                    <td>{{ b.maturity_date }}</td>
                    <td>
                      <span{% if b.valuation_class %} class="{{ b.valuation_class }}"{% endif %}>
                        {{ b.estimated_total|floatformat:2 }}
                      </span>
                    </td>
                    <td>{{ b.currency }}</td>
                    <td>
                      <a class="btn btn-sm btn-outline-primary" href="{% url 'tm_assets:edit_bond' b.pk %}">수정</a>
                      <form method="post" action="{% url 'tm_assets:delete_bond' b.pk %}" class="d-inline">
                        {% csrf_token %}
                        <button class="btn btn-sm btn-outline-danger" type="submit" onclick="return confirm('삭제하시겠습니까?');">삭제</button>
                      </form>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted mb-0">등록된 채권이 없습니다.</p>
        {% endif %}
      </div>
    </div>
  </div>
{% if history_has_data %}
  {{ portfolio_history|json_script:"portfolio-history-data" }}
  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>자산 추이</span>
      <small class="text-muted">처음 자산 기록부터 현재까지</small>
    </div>
    <div class="card-body" style="height: 400px;">
      <canvas id="portfolioHistoryChart" style="height: 100%;"></canvas>
    </div>
  </div>
{% endif %}

</div>

{% endblock %}

{% block extra_js %}
  {{ block.super }}
  {% if history_has_data %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script>
      (function () {
        const dataElement = document.getElementById('portfolio-history-data');
        if (!dataElement) {
          return;
        }
        const historyData = JSON.parse(dataElement.textContent);
        if (!historyData.length) {
          return;
        }
        const labels = historyData.map(item => item.date);
        const totals = historyData.map(item => Number(item.total_value) || 0);
        const deposits = historyData.map(item => Number(item.deposit_value) || 0);
        const stocks = historyData.map(item => Number(item.stock_value) || 0);
        const bonds = historyData.map(item => Number(item.bond_value) || 0);
        const ctx = document.getElementById('portfolioHistoryChart');
        if (!ctx) {
          return;
        }
        const numberFormatter = new Intl.NumberFormat(undefined, { maximumFractionDigits: 2 });
        new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              {
                label: '총 자산',
                data: totals,
                borderColor: '#d63384',
                backgroundColor: 'rgba(214, 51, 132, 0.15)',
                borderWidth: 2,
                tension: 0.25,
                fill: true,
              },
              {
                label: '예적금',
                data: deposits,
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                borderWidth: 1.5,
                tension: 0.25,
                fill: false,
              },
              {
                label: '주식',
                data: stocks,
                borderColor: '#198754',
                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                borderWidth: 1.5,
                tension: 0.25,
                fill: false,
              },
              {
                label: '채권',
                data: bonds,
                borderColor: '#6f42c1',
                backgroundColor: 'rgba(111, 66, 193, 0.1)',
                borderWidth: 1.5,
                tension: 0.25,
                fill: false,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { intersect: false, mode: 'index' },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: value => numberFormatter.format(value),
                },
              },
            },
            plugins: {
              legend: { position: 'top' },
              tooltip: {
                callbacks: {
                  label: context => {
                    const value = context.parsed.y ?? 0;
                    return `${context.dataset.label}: ${numberFormatter.format(value)}`;
                  },
                },
              },
            },
          },
        });
      })();
    </script>
  {% endif %}
{% endblock %}
